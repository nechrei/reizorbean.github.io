<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeddychan</title>
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="chatbox" class="neon-chatbox">
            <div class="chat-header">
                Chat Room 
                <button class="minimize-button" onclick="toggleChatbox()">&#x25B2;</button>
            </div>
            <div class="messages" id="messages"></div>
            <div id="statusMessage" class="status-message" style="color: red;">Loading messages...</div>
            <div id="userInfo" class="user-info" style="color: rgb(81, 165, 229);"></div>
            <input type="text" id="messageInput" class="message-input" placeholder="Type a message..." />
            <button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
            <button id="claimButton" class="claim-button" onclick="claimDisplayName()">display name options</button>
            <div id="claim" class="claim" style="color: rgba(36, 102, 255, 0.711);">
                <div id="descLogin" class="desc-login" style="color: rgba(36, 102, 255, 0.711);">Claim display name with seamless login, register, name, pw change:</div>
                <input type="text" id="displayNameInput" class="display-name-input" placeholder="Enter your display name..." />
                <input type="text" id="emailInput" class="name-input" placeholder="Enter your email..." />
                <input type="password" id="passwordInput" class="password-input" placeholder="Enter your password..." />
                <button id="forgotPasswordButton" class="forgot-password-button" onclick="forgotPassword()">Forgot Password?</button>
                <button id="signOutButton" class="sign-out-button" onclick="signOut()">sign out</button>
            </div>
        </div>
        <button id="openChatButton" class="hidden" onclick="toggleChatbox()">Open Chat</button>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, get } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcV2wJ2tvOYEH_tW1sIi3YXOURy6h7VTo",
            authDomain: "zeddychan.firebaseapp.com",
            databaseURL: "https://zeddychan-default-rtdb.firebaseio.com",
            projectId: "zeddychan",
            storageBucket: "zeddychan.appspot.com",
            messagingSenderId: "556479718409",
            appId: "1:556479718409:web:c6bfd066216922f35484d8",
            measurementId: "G-8W0CHH4G68"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        const sendButton = document.getElementById("sendButton");
        const claimButton = document.getElementById("claimButton");
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const messageInput = document.getElementById("messageInput");
        const chatbox = document.getElementById("chatbox");
        const openChatButton = document.getElementById("openChatButton");
        const statusMessageDiv = document.getElementById("statusMessage");
        const userInfoDiv = document.getElementById("userInfo");
        const signOutButton = document.getElementById("signOutButton");
        onAuthStateChanged(auth, (user) => {
            checkUser(user);
        });
        function checkUser() {
            // CHECK CURRENT USER
            const user = auth.currentUser;

            if (user) {
                statusMessageDiv.textContent = "Hello, human.";

                const userEmail = user.email;
                const userRef = ref(database, `users/${auth.currentUser.uid}`);

                // Fetch display name from the database
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    const displayName = userData ? userData.displayName || 'Anonymous' : 'Anonymous';

                    updateUIForLoggedInUser(displayName); // Use the actual displayName here
                    signOutButton.style.display = "block";
                });
            }
        }
        userInfoDiv.textContent = "Anonymous";
        //signOutButton.style.display = "block";
        function loadMessages() {
            
            statusMessageDiv.textContent = "Loading messages...";
            setTimeout(() => {
            const messagesRef = ref(database, 'publicChatRooms/defaultRoom/messages');
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = '';

                for (const key in messages) {
                    const message = messages[key];
                    const messageElement = document.createElement("div");
                    messageElement.className = "message";
                    messageElement.textContent = `${message.name || 'Anonymous'}: ${message.text} (sent at ${new Date(message.timestamp).toLocaleTimeString()})`;
                    messagesDiv.appendChild(messageElement);
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                sendButton.disabled = false;
            }, (error) => {
                console.error("Error reading data:", error);
                statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                sendButton.disabled = true;
            });
            statusMessageDiv.textContent = "";}, 310);
        }
        sendButton.disabled = true;

        loadMessages();
        let isSendingMessage = false;
        let isBusySending = false;

        let existingDisplayNames = [];

        const publicDisplayNamesRef = ref(database,'publicDisplayNames');

        onValue(publicDisplayNamesRef, (snapshot) => {
        const allDisplayNames = snapshot.val();
        
        // Extract display names from the data
        existingDisplayNames = Object.values(allDisplayNames || {}).map(user => user.displayName);
        
            // Log all display names
            //console.log("All Public Display Names:", existingDisplayNames);
        }, (error) => {
            console.error("Error fetching public display names:", error);
        });

        let openedClaimBox = false;

        window.claimDisplayName = function() {
            if (!openedClaimBox){
                // Display a confirmation dialog
                const userConfirmed = confirm("You will need to claim your display name using an email address and a password of your choice. Please create a random password that you do not use elsewhere, and reserve it solely for this page. I can view your email address but will not have access to it.");

                // If the user clicks Cancel, return early
                if (!userConfirmed) {
                    return;
                }
            }

            const claimDiv = document.getElementById('claim');
            if (claimDiv.style.display === "none" || claimDiv.style.display === "") {
                openedClaimBox = true;
                claimDiv.style.display = "contents"; // Show the contents
            } else {
                openedClaimBox = false;
                claimDiv.style.display = "none"; // Hide the contents
            }
        }

        // ---------------------------------------------------------SENDING A MESSAGE
        window.sendMessage = function() {

        if (isSendingMessage) return;
        isSendingMessage = true;

        console.log("sendMessage called");
        sendButton.disabled = true;
        statusMessageDiv.textContent = "Loading...";

        setTimeout(() => {
        const messageText = messageInput.value.trim();
        const userEmail = emailInput.value.trim();
        const userPassword = passwordInput.value.trim();

        if (messageText === "") {
            statusMessageDiv.textContent = "Input is required.";
            sendButton.disabled = false;
            return;
        }

        // Get the current user
        const user = auth.currentUser;

        if (user) {
            console.log("Sending with user");

            const userEmail = user.email;
            const userRef = ref(database, `users/${auth.currentUser.uid}`);
            if (displayNameInput.value !== "") {
                if (existingDisplayNames.includes(displayName)) {
                    console.log("ALREADY TAKEN");
                    statusMessageDiv.textContent = "Display name already taken. Please choose another.";
                    sendButton.disabled = false;
                    return; // Return false if the name is taken
                }
                saveDisplayName(userEmail, displayNameInput.value.trim());
            }
            // Fetch display name from the database
            get(userRef).then((snapshot) => {
                if (isBusySending) return;
                isBusySending = true;

                const userData = snapshot.val();
                const displayName = userData.displayName || 'Anonymous';

                const messageData = {
                    name: displayName,
                    text: messageText,
                    timestamp: Date.now(),
                    ownerId: auth.currentUser.uid
                };

                push(ref(database, 'publicChatRooms/defaultRoom/messages'), messageData)
                    .then(() => {
                        updateUIForLoggedInUser(displayName);
                        messageInput.value = "";
                        statusMessageDiv.textContent = `Message sent. ${new Date(Date.now()).toLocaleTimeString()}`;
                        passwordInput.value = ""; // Clear password
                        displayNameInput.value = "";
                    })
                    .catch((error) => {
                        console.error("Error writing data:", error);
                        statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                    });
            });
        } 
        else {


        // Check if email is provided
        if (userEmail === "") {
                // Send as anonymous
                const messageData = {
                    name: "Anonymous",
                    text: messageText,
                    timestamp: Date.now(),
                    ownerId: "anon"
                };
                push(ref(database, 'publicChatRooms/defaultRoom/messages'), messageData)
                    .then(() => {
                        console.log("anonymous push called");
                        messageInput.value = "";
                        statusMessageDiv.textContent = "Message sent as Anonymous.";
                        userInfo.textContent = "Anonymous";
                        sendButton.disabled = false;
                    })
                    .catch((error) => {
                        console.error("Error writing data:", error);
                        statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                        sendButton.disabled = true;
                    });
            } else {
                    // Attempt to login/register
                    signInWithEmailAndPassword(auth, userEmail, userPassword)
                        .then(() => {
                            sendButton.disabled = true;
                            if (displayNameInput.value !== "") {
                                if (existingDisplayNames.includes(displayNameInput.value)) {
                                    console.log("ALREADY TAKEN");
                                    statusMessageDiv.textContent = "Display name already taken. Please choose another.";
                                    sendButton.disabled = false;
                                    return; // Return false if the name is taken
                                }
                                saveDisplayName(userEmail, displayNameInput.value.trim());
                            }
                            // Fetch the display name from the database
                            const userRef = ref(database, `users/${auth.currentUser.uid}`);
                            get(userRef).then((snapshot) => {
                                if (isBusySending) return;
                                 isBusySending = true;

                                const userData = snapshot.val();
                                const displayName = userData.displayName || 'Error loading name';

                                const messageData = {
                                    name: displayName, // Use display name from database
                                    text: messageText,
                                    timestamp: Date.now(),
                                    ownerId: auth.currentUser.uid
                                };
                                
                                push(ref(database, 'publicChatRooms/defaultRoom/messages'), messageData)
                                .then(() => {
                                    console.log("signed in sent message called");
                                    statusMessageDiv.textContent = "";
                                    
                                    messageInput.value = "";
                                    passwordInput.value = ""; // Clear password
                                    updateUIForLoggedInUser(displayName);
                                    displayNameInput.value = "";
                                    
                                    sendButton.disabled = false;
                                    
                                })
                                .catch((error) => {
                                    console.error("Error writing data:", error);
                                    statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                                    sendButton.disabled = true;
                                });  
                            }).catch((error) => {
                                console.error('Error fetching user data on sign in!!:', error);
                                statusMessageDiv.textContent = "Error";
                            });
                        })
                        .catch((error) => {
                            sendButton.disabled = true;

                            if (error.code === 'auth/user-not-found') {
                                // Not registered, attempt to register
                                let displayName = displayNameInput.value.trim();
                                displayName = displayName === "" ? generateDisplayNameWithToken() : displayName;
                                if (existingDisplayNames.includes(displayName)) {
                                    console.log("ALREADY TAKEN");
                                    statusMessageDiv.textContent = "Display name already taken. Please choose another.";
                                    sendButton.disabled = false;
                                    return; // Return false if the name is taken
                                }
                                console.log("Sending with user2");
                                createUserWithEmailAndPassword(auth, userEmail, userPassword)
                                    .then(() => {
                                        if (!saveDisplayName(userEmail, displayName)){
                                            console.log("FAILED DISPLAY NAME");
                                            statusMessageDiv.textContent =  "Failed.";
                                        }
                                        const messageData = {
                                            text: messageText,
                                            name: displayName,
                                            timestamp: Date.now(),
                                            ownerId: auth.currentUser.uid
                                        };

                                        push(ref(database, 'publicChatRooms/defaultRoom/messages'), messageData)
                                            .then(() => {
                                                statusMessageDiv.textContent = "";
                                                console.log("registration 01 push called");
                                                messageInput.value = "";
                                                passwordInput.value = ""; // Clear password
                                                updateUIForNewRegisteredInUser(displayName);
                                                sendButton.disabled = false;
                                            })
                                            .catch((error) => {
                                                console.error("Error writing data:", error);
                                                statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                                                sendButton.disabled = true;
                                            });
                                    })
                                    .catch((error) => {
                                        statusMessageDiv.textContent = error.message;
                                    });
                                
                            } else if (error.code === 'auth/invalid-credential') {
                                console.log("Sending with user3");

                                let displayName = displayNameInput.value.trim();
                                displayName = displayName === "" ? generateDisplayNameWithToken() : displayName;
                                if (existingDisplayNames.includes(displayName)) {
                                    console.log("ALREADY TAKEN");
                                    statusMessageDiv.textContent = "Display name already taken. Please choose another.";
                                    sendButton.disabled = false;
                                    return; // Return false if the name is taken
                                }
                                    createUserWithEmailAndPassword(auth, userEmail, userPassword)
                                    .then(() => {
                                         if (!saveDisplayName(userEmail, displayName)){
                                            console.log("FAILED DISPLAY NAME");
                                            statusMessageDiv.textContent =  "Failed.";
                                        }
                                        const messageData = {
                                            text: messageText,
                                            name: displayName,
                                            timestamp: Date.now(),
                                            ownerId: auth.currentUser.uid
                                        };

                                        push(ref(database, 'publicChatRooms/defaultRoom/messages'), messageData)
                                            .then(() => {
                                                statusMessageDiv.textContent = "";
                                                console.log("registration 02 push called");
                                                messageInput.value = "";
                                                passwordInput.value = ""; // Clear password
                                                updateUIForNewRegisteredInUser(displayName);
                                                sendButton.disabled = false;

                                            })
                                            .catch((error) => {
                                                console.error("Error writing data:", error);
                                                statusMessageDiv.textContent = "Maintenance! Come back tomorrow or later.";
                                                sendButton.disabled = true;
                                            });
                                    })
                                    .catch((error) => {
                                        statusMessageDiv.textContent = "Something went wrong. Please try it again or nech an696 9 at gmaildotcom for support. or make sure your password is correct.";
                                    });
                               
                            } else if (error.code === 'auth/missing-password') {
                                statusMessageDiv.textContent =  "Enter password.";
                            } else {
                                // Handle other errors
                                statusMessageDiv.textContent = "Too many attempts or something went wrong. Please try it again later or nech an696 9 at gmaildotcom for support. - or make sure your password is correct.";
                            }
                        });
                }
            }
            isSendingMessage = false;
            isBusySending = false;

            }, 1250);

            isSendingMessage = false;
            isBusySending = false;
        }
        let isBusyUpdatingName = false;


        async function saveDisplayName(userEmail, displayName) {
            if (isBusyUpdatingName) return false; // Return false if already busy
            
            isBusyUpdatingName = true;

            if (existingDisplayNames.includes(displayName)) {
                console.log("ALREADY TAKEN");
                statusMessageDiv.textContent = "Display name already taken. Please choose another.";
                sendButton.disabled = false;
                isBusyUpdatingName = false; // Reset the busy state
                return false; // Return false if the name is taken
            }

            const userRef = ref(database, `users/${auth.currentUser.uid}`);
            const publicDisplayNamesRef  = ref(database, `publicDisplayNames/${auth.currentUser.uid}`);
            try {
                await update(userRef, { 
                    displayName, 
                    email: userEmail 
                });
                await set(publicDisplayNamesRef, { displayName })
                .then(() => {
                    console.log("Display name updated successfully!");
                })
                .catch((error) => {
                    console.error("Error updating display name:", error);
                });

                statusMessageDiv.textContent = "Display name changed.";
                console.log("Display name changed.");
                return true; // Return true on success
            } catch (error) {
                console.error("Error writing data:", error);
                statusMessageDiv.textContent = error.message;
                return false; // Return false on error
            } finally {
                isBusyUpdatingName = false; // Reset the busy state
            }
        }


        function generateDisplayNameWithToken() {
            let randomToken;
            
            // Generate a unique token
            do {
                randomToken = Math.random().toString(36).substring(2, 12);
            } while (existingDisplayNames.includes(`User_${randomToken}`)); // Check for duplicates

            return `User_${randomToken}`; // Return the unique display name
        }

        function updateUIForLoggedInUser(displayName) {
            passwordInput.style.display = "none";
            displayNameInput.style.display = "none";
            userInfo.textContent = `Welcome ${displayName}.`;
        }

        function updateUIForNewRegisteredInUser(displayName) {
            passwordInput.style.display = "none";
            displayNameInput.style.display = "none";
            userInfo.textContent = `Welcome ${displayName}.`;
        }

        window.toggleChatbox = function() {
            const isMinimized = chatbox.style.display === 'none';
            chatbox.style.display = isMinimized ? 'flex' : 'none';
            openChatButton.style.display = isMinimized ? 'none' : 'block';
        }

        window.forgotPassword = function() {
            const userEmail = emailInput.value.trim();

            if (userEmail === "") {
                statusMessageDiv.textContent = "Please enter your email address.";
                return;
            }

            sendPasswordResetEmail(auth, userEmail)
                .then(() => {
                    statusMessageDiv.textContent = "If you are registered, you will receive a password reset email.";
                })
                .catch((error) => {
                    console.error(error); 
                    statusMessageDiv.textContent = "If you are registered, you will receive a password reset email.";
                });
        }
        function resetUIForLoggedOutUser() {
            passwordInput.style.display = "block"; // Show password input
            displayNameInput.style.display = "block"; // Show display name input
            emailInput.value = ""; // Clear email input
            passwordInput.value = ""; // Clear password input
            displayNameInput.value = ""; // Clear display name input
            userInfo.textContent = "";
            signOutButton.style.display = "none";
        }

        window.signOut = function() {
            signOut(auth)
                .then(() => {
                    // Sign-out successful.
                    statusMessageDiv.textContent = "You have been signed out.";
                    resetUIForLoggedOutUser(); // Reset UI for logged out state
                })
                .catch((error) => {
                    console.error("Error signing out:", error);
                    statusMessageDiv.textContent = "Error signing out. Please try again.";
                });
        };

    </script>
</body>
</html>
